#:import Gradient modules.gradient.Gradient
#:import ceil math.ceil
#:import QUEUE_TIME_MAX src.game.crafting_queue.QUEUE_TIME_MAX

<CraftingMain>:
    name: 'crafting_main'
    background_source: 'crafting.png'
    title_source: 'screen_title/crafting.png'
    RelativeLayout:
        size_hint: 0.633, 0.1
        pos_hint: {'x': 0.333, 'y': 0.8}
        Image:
            allow_stretch: True
            keep_ratio: False
            source: 'crafting_queue.png'
            on_size: print(str(args))
        RelativeLayout:
            size_hint: 0.192, 1
            Label:
                size_hint: 0.8, 0.5
                pos_hint: {'top': 1}
                font_name: 'Gabriola'
                font_size: '26sp'
                color: 0, 0, 0, 1
                text: 'Queue Time:'
            Label:
                size_hint: 0.8, 0.5
                font_name: 'Gabriola'
                font_size: '26sp'
                color: 0, 0, 0, 1
                text: 'Queue Count:'
            Label:
                size_hint: 0.2, 0.5
                pos_hint: {'top': 1, 'right': 1}
                font_name: 'Gabriola'
                font_size: '26sp'
                color: 0, 0, 0, 1
                text: str(crafting_queue.queue_time)
            Label:
                size_hint: 0.2, 0.5
                pos_hint: {'right': 1}
                font_name: 'Gabriola'
                font_size: '26sp'
                text: str(crafting_queue.queue_count)
                color: 0, 0, 0, 1
        CraftingQueue:
            id: crafting_queue
            size_hint: 0.802, 0.95
            pos_hint: {'x': 0.198, 'center_y': 0.5}
            on_item_crafted: root.update_item_info(*args)
    ScrollView:
        size_hint: 0.3, 0.75
        pos_hint: {'x': 0.333, 'y': 0.025}
        do_scroll_x: False
        effect_cls: 'ScrollEffect'
        always_overscroll: False
        StackLayout:
            id: view
            size_hint: 1, None
            height: self.minimum_height
            orientation: 'lr-tb'
            spacing: root.height * 0.0125
    ItemCraftingPanel:
        id: crafting_panel
        size_hint: 0.3, 0.75
        pos_hint: {'x': 0.666, 'y': 0.025}
        opacity: 1 if root.crafting_visible else 0
        available_queue_time: QUEUE_TIME_MAX - crafting_queue.queue_time
    EquipmentCraftingPanel:
        id: equipment_panel
        size_hint: 0.3, 0.75
        pos_hint: {'x': 0.666, 'y': 0.025}
        opacity: 1 if root.equipment_visible else 0
        available_queue_time: QUEUE_TIME_MAX - crafting_queue.queue_time
    SpineDisplay:
        id: spine_display
        skeleton_path: 'res/characters/real_spines/hestaphus/1112031000.skel'

<CraftingDisplay>:
    PPCHoverPathButton:
        path: 'buttons/shop_display'
        on_release: root.do_callback()
        disabled: root.locked
    Label:
        size_hint: None, None
        size: self.texture_size
        pos_hint: {'x': 0.1, 'center_y': 0.5}
        font_name: 'Precious'
        font_size: '26sp'
        text: root.text
        color: 0, 0, 0, 1
    Image:
        id: icon
        size_hint: None, 0.9
        width: self.height
        pos_hint: {'center_y': 0.5}
        right: root.width - self.y
        source: root.image_source
        allow_stretch: True
        opacity: 0 if root.image_source == '' else 1
    Image:
        id: lock
        source: 'crafting_display_lock.png'
        allow_stretch: True
        opacity: 1 if root.locked else 0

<CraftingRecipeDisplay>:
    size_hint: 1, None
    height: root.main_height + root.sub_height
    RelativeLayout:
        size_hint: 1, None
        height: root.main_height
        y: root.sub_height
        PPCHoverPathButton:
            path: 'buttons/shop_display'
            on_release: root.do_callback()
            disabled: root.button_disabled
        Label:
            size_hint: None, None
            size: self.texture_size
            pos_hint: {'x': 0.1, 'center_y': 0.7}
            font_name: 'Precious'
            font_size: '22sp'
            text: root.text
            color: 0, 0, 0, 1
        Label:
            size_hint: 0.75, None
            height: self.texture_size[1]
            text_size: self.width, None
            pos_hint: {'x': 0.1, 'center_y': 0.3}
            font_name: 'Precious'
            font_size: '18sp'
            text: root.sub_text
            color: 0, 0, 0, 1
        Label:
            size_hint: None, None
            size: self.texture_size
            pos_hint: {'center_y': 0.7, 'right': 0.75}
            font_name: 'Precious'
            font_size: '16sp'
            text: root.count
            color: 0, 0, 0, 1
        Image:
            id: frame_background
            size_hint: None, 0.55
            width: self.height
            pos_hint: {'center_y': 0.675}
            right: root.width - self.y
            opacity: 0 if root.image_source == '' else 1
            source: 'items/frame_1.png'
            allow_stretch: True
        Image:
            id: icon
            size_hint: None, 0.55
            width: self.height
            pos_hint: {'center_y': 0.675}
            right: root.width - self.y
            opacity: 0 if root.image_source == '' else 1
            allow_stretch: True
            source: root.image_source
        Image:
            id: frame_overlay
            size_hint: None, 0.55
            width: self.height
            pos_hint: {'center_y': 0.675}
            right: root.width - self.y
            opacity: 0 if root.image_source == '' else 1
            allow_stretch: True
            source: 'items/frame_top_1.png'
        Label:
            size_hint: None, None
            size: self.texture_size
            pos_hint: {'center_y': 0.15, 'right': 0.975}
            font_name: 'Precious'
            font_size: '16sp'
            text: root.inventory
            color: 0, 0, 0, 1
    RecycleView:
        id: ingredient_view
        size_hint: 0.951, None
        pos_hint: {'x': 0.049}
        height: root.sub_height
        viewclass: 'IngredientDisplay'
        effect_cls: 'ScrollEffect'
        always_overscroll: False
        data: root.ingredients
        RecycleBoxLayout:
            id: page_layout
            default_size: None, root.ingredient_height
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'

<IngredientDisplay>:
    Image:
        allow_stretch: True
        keep_ratio: False
        source: root.background_source
    Label:
        size_hint: None, None
        size: self.texture_size
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        font_name: 'Precious'
        font_size: '22sp'
        text: root.text
        color: 0, 0, 0, 1
    Label:
        size_hint: None, None
        size: self.texture_size
        pos_hint: {'center_y': 0.5, 'right': 0.975}
        font_name: 'Precious'
        font_size: '16sp'
        text: root.count
        color: 0, 0, 0, 1
    Image:
        id: icon
        size_hint: None, 0.9
        width: self.height
        pos_hint: {'center_y': 0.5, 'x': 0.05}
        source: root.image_source
        allow_stretch: True
        opacity: 0 if root.image_source == '' else 1

<CountAdjuster>:
    Label:
        id: count
        size_hint: 1, 0.33
        pos_hint: {'top': 1}
        font_name: 'Gabriola'
        font_size: '48sp'
        color: 0, 0, 0, 1
        text: str(slider.value)
    RelativeLayout:
        size_hint: 1, 0.33
        pos_hint: {'center_y': 0.5}
        Button:
            size_hint: None, 0.75
            width: self.height
            pos_hint: {'right': 0.1, 'center_y': 0.5}
            font_name: 'Gabriola'
            font_size: '30sp'
            text: '-'
            on_release: slider.value = max(root.min, slider.value - 1)
        Slider:
            id: slider
            size_hint: 0.75, 1
            pos_hint: {'x': 0.125}
            on_value: root.dispatch('on_value', self.value)
            step: 1
            min: root.min
            max: root.max
        Button:
            size_hint: None, 0.75
            width: self.height
            pos_hint: {'x': 0.9, 'center_y': 0.5}
            font_name: 'Gabriola'
            font_size: '30sp'
            text: '+'
            on_release: slider.value = min(root.max, slider.value + 1)
    BoxLayout:
        size_hint: 1, 0.33
        orientation: 'horizontal'
        spacing: self.width * 0.125
        padding: self.width * 0.125, 0
        Button:
            font_name: 'Gabriola'
            font_size: '30sp'
            text: 'Min'
            on_release: slider.value = root.min
        Button:
            font_name: 'Gabriola'
            font_size: '30sp'
            text: 'Half'
            on_release: slider.value = floor(root.min + (root.max - root.min) / 2)
        Button:
            font_name: 'Gabriola'
            font_size: '30sp'
            text: 'Max'
            on_release: slider.value = root.max

<IngredientList>:
    RelativeLayout:
        id: ingredient_headers
        size_hint: 1, 0.175
        pos_hint: {'top': 1, 'center_x': 0.5}
        Label:
            id: image
            size_hint: 0.33, 1
            text_size: self.size
            halign: 'left'
            font_name: 'Precious'
            font_size: '30sp'
            color: 0, 0, 0, 1
            text: 'Image'
        Label:
            id: material
            size_hint: 0.33, 1
            text_size: self.size
            pos_hint: {'center_x': 0.5}
            halign: 'center'
            font_name: 'Precious'
            font_size: '30sp'
            color: 0, 0, 0, 1
            text: 'Material'
        Label:
            id: quantity
            size_hint: 0.33, 1
            text_size: self.size
            pos_hint: {'right': 1}
            halign: 'right'
            font_name: 'Precious'
            font_size: '30sp'
            color: 0, 0, 0, 1
            text: 'Quantity'
    RecycleView:
        id: ingredient_view
        size_hint: 1, 0.825
        viewclass: 'IngredientDisplay'
        effect_cls: 'ScrollEffect'
        always_overscroll: False
        RecycleBoxLayout:
            id: box_layout
            default_size: None, ingredient_headers.height
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'

<ItemCraftingPanel>:
    Image:
        allow_stretch: True
        source: 'crafting_panel_background.png'
    RelativeLayout:
        size_hint: 1, 0.15
        pos_hint: {'top': 0.975}
        Label:
            id: title
            size_hint: 0.75, 0.33
            pos_hint: {'x': 0.025, 'top': 1}
            text_size: self.width, None
            halign: 'left'
            font_name: 'Precious'
            font_size: '40sp'
            text: root.item_name
            color: 0, 0, 0, 1
        Label:
            id: description
            size_hint: 0.75, 0.66
            text_size: self.size
            pos_hint: {'x': 0.075}
            valign: 'top'
            halign: 'left'
            font_name: 'Precious'
            font_size: '24sp'
            text: root.item_description
            color: 0, 0, 0, 1
        Image:
            id: frame_background
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            source: 'items/frame_1.png'
            allow_stretch: True
        Image:
            id: icon
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            allow_stretch: True
            source: root.image_source
        Image:
            id: frame_overlay
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            allow_stretch: True
            source: 'items/frame_top_1.png'
    RelativeLayout:
        id: item_info
        size_hint: 0.8, 0.1
        pos_hint: {'top': 0.825}
        Label:
            size_hint: 0.75, 0.5
            pos_hint: {'top': 1}
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: 'In Inventory:'
        Label:
            size_hint: 0.25, 0.5
            pos_hint: {'top': 1, 'right': 1}
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: str(root.in_inventory)
        Label:
            size_hint: 0.75, 0.5
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: 'Queue Time:'
            color: (0, 0, 0, 1) if root.queue_time < root.available_queue_time else (1, 0, 0, 1)
        Label:
            size_hint: 0.25, 0.5
            pos_hint: {'right': 1}
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: str(root.queue_time)
            color: (0, 0, 0, 1) if root.queue_time < root.available_queue_time else (1, 0, 0, 1)
    IngredientList:
        id: ingredient_list
        size_hint: 0.9, 0.425
        pos_hint: {'top': 0.725, 'center_x': 0.5}
    CountAdjuster:
        id: count_adjuster
        size_hint: 1, 0.2
        pos_hint: {'y': 0.1}
        on_value: root.update_cost(args[1])
    Button:
        size_hint: 0.75, 0.05
        pos_hint: {'center_x': 0.5, 'y': 0.025}
        font_name: 'Gabriola'
        font_size: '30sp'
        text: 'Craft'
        disabled: True if root.queue_time > root.available_queue_time else False
        on_release: root.do_craft()

<EquipmentCraftingPanel>:
    Image:
        allow_stretch: True
        source: 'crafting_panel_background.png'
    RelativeLayout:
        size_hint: 1, 0.15
        pos_hint: {'top': 0.975}
        Label:
            id: title
            size_hint: 0.75, 0.33
            pos_hint: {'x': 0.025, 'top': 1}
            text_size: self.width, None
            halign: 'left'
            font_name: 'Precious'
            font_size: '40sp'
            text: root.item_name
            color: 0, 0, 0, 1
        Label:
            id: description
            size_hint: 0.75, 0.66
            text_size: self.size
            pos_hint: {'x': 0.075}
            valign: 'top'
            halign: 'left'
            font_name: 'Precious'
            font_size: '24sp'
            text: root.item_description
            color: 0, 0, 0, 1
        Image:
            id: frame_background
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            source: 'items/frame_1.png'
            allow_stretch: True
        Image:
            id: icon
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            allow_stretch: True
            source: root.image_source
        Image:
            id: frame_overlay
            size_hint: None, 0.66
            width: self.height
            pos_hint: {'right': 0.975, 'top': 1}
            allow_stretch: True
            source: 'items/frame_top_1.png'
    RelativeLayout:
        id: item_info
        size_hint: 0.8, 0.05
        pos_hint: {'top': 0.825}
        Label:
            size_hint: 0.75, 1
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: 'Queue Time:'
            color: (0, 0, 0, 1) if root.queue_time < root.available_queue_time else (1, 0, 0, 1)
        Label:
            size_hint: 0.25, 1
            pos_hint: {'right': 1}
            font_name: 'Gabriola'
            font_size: '36sp'
            color: 0, 0, 0, 1
            text: str(root.queue_time)
            color: (0, 0, 0, 1) if root.queue_time < root.available_queue_time else (1, 0, 0, 1)
    IngredientList:
        id: ingredient_list
        size_hint: 0.9, 0.425
        pos_hint: {'top': 0.775, 'center_x': 0.5}
    GridLayout:
        id: modification_buttons
        pos_hint: {'center_x': 0.5, 'y': 0.1}
        size_hint: 0.75, None
        height: self.minimum_height
        cols: 1
        # default_size_hint: 1, None
        row_default_height: craft_button.height
        row_force_default: True

    Button:
        id: craft_button
        size_hint: 0.75, 0.05
        pos_hint: {'center_x': 0.5, 'y': 0.025}
        font_name: 'Gabriola'
        font_size: '30sp'
        text: 'Craft'
        disabled: True if root.queue_time > root.available_queue_time else False
        on_release: root.do_craft()

<CraftingQueue>:
    ScrollView:
        BoxLayout:
            id: box_layout
            size_hint: None, 1
            width: self.minimum_width
            padding: self.height * 0.05
            spacing: self.height * 0.05

<CraftingItemDisplay>:
    size_hint: None, 1
    width: self.height
    Image:
        id: frame_background
        size_hint: 0.85, 0.85
        pos_hint: {'top': 1}
        source: 'items/frame_1.png'
        allow_stretch: True
    Image:
        id: item
        size_hint: 0.85, 0.85
        pos_hint: {'top': 1}
        allow_stretch: True
        source: root.image_source
    Image:
        id: frame_overlay
        size_hint: 0.85, 0.85
        pos_hint: {'top': 1}
        allow_stretch: True
        source: 'items/frame_top_1.png'
    BoxLayout:
        id: image_layout
        size_hint: 0.3, 0.775
        pos_hint: {'top': 0.975, 'right': 0.975}
        orientation: 'vertical'
        height: self.minimum_height
        spacing: root.height * 0.025
    RelativeLayout:
        id: progress_bar
        size_hint: 0.85, 0.15
        canvas:
            Rectangle:
                size: self.size
                texture: Gradient.horizontal_time(self.width * root.current_time / root.time, self.width, self.height, (180, 236, 180, 255), (250, 160, 160, 255))
    Label:
        size_hint: 0.15, 0.15
        pos_hint: {'right': 1}
        font_name: 'Gabriola'
        font_size: '20sp'
        color: 0, 0, 0, 1
        text: str(ceil(root.current_time))